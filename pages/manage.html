---
permalink: /manage
---

<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
		<link rel="stylesheet" type="text/css" href="{{ site.baseurl }}/res/css/style.css"/>	
 		<link href="https://fonts.googleapis.com/css?family=Halant:400|Raleway:500|Roboto:400,500,700" rel="stylesheet">
		<style>
			#app {
				display: none;
			}
		</style>
	</head>
	<body>
		
	
		
		<div id="manage-menu">

			<img src="{{ site.baseurl }}/res/img/visiblepeeps.png">

			<ul class="menu-menu">

				<li><a href="{{ site.baseurl }}/" style="border-top:1px solid rgb(235,235,235);">Home</a></li>
				<li><a href="{{ site.baseurl }}/submit">Submit</a></li>
				<li><a href="">Adminstrators</a></li>
				<li><a href="">Blocked Users</a></li>
				<li><a href="">Log in / Out</a></li>

			</ul>

		</div>
		
		<div id="manage-content">
		
		<div id="app">
			<div v-if="isLoggedIn && isAdmin">
				<p>
					<button @click="logout">Log out</button>
				</p>
				
				<h2>Tweets to Approve</h2>
				
				<ul class="tweetiesToApprove" v-if="tweetsToApprove.length > 0">
					<li v-for="tweet in tweetsToApprove">
						<button style="margin:0 2em 0 0" @click="approve(tweet)">Approve</button>
						<button @click="deny(tweet)">Deny</button>
						<a target="_blank" :href="tweet.url"><% tweet.url %></a> submitted by <a :href="'https://twitter.com/' + tweet.submitter"><% tweet.submitter %></a>
						
					</li>
				</ul>
				
				<p v-else>
					There are no tweets to approve at this time.
				</p>
				
				<h2>Admin Users</h2>
				
				<form @submit.prevent="addAdminUser(userToAdmin)">
					<input type="text" v-model="userToAdmin">
					<input type="submit" value="Add">
				</form>
				
				<ul>
					<li v-for="username in adminUsers">
						<a :href="'https://twitter.com/' + username"><% username %></a>
						<button @click="removeAdminUser(username)">Remove</button>
					</li>
				</ul>
				
				<h2>Blocked Users</h2>
				
				<form @submit.prevent="blockUser(userToBlock)">
					<input type="text" v-model="userToBlock">
					<input type="submit" value="Block">
				</form>
				
				<ul>
					<li v-for="username in blockedUsers">
						<a :href="'https://twitter.com/' + username"><% username %></a>
						<button @click="unblockUser(username)">Unblock</button>
					</li>
				</ul>
			</div>
			
			<div v-else>
				<button @click="login">Log in</button>
			</div>
		</div>
		
		<script src="{{ site.baseurl }}/res/js/firebase.js"></script>
		<script src="{{ site.baseurl }}/res/js/vue.min.js"></script>
		<script>
			window.onload = function(){
				let ref3, ref4, ref5, ref6;
				
				firebase.initializeApp({
					apiKey: "AIzaSyDahkALUP2HDnuLqiXOt-ScOPobhqFoW84",
					authDomain: "visiblewomen-net.firebaseapp.com",
					databaseURL: "https://visiblewomen-net.firebaseio.com",
					projectId: "visiblewomen-net",
					storageBucket: "visiblewomen-net.appspot.com",
					messagingSenderId: "532732660193"
				});
				
				let app = new Vue({
					el: "#app",
					delimiters: ["<%", "%>"],
					
					data: {
						isLoggedIn: false,
						isAdmin: false,
						currentUserName: "",
						tweetsToApprove: [],
						userToAdmin: "",
						adminUsers: [],
						userToBlock: "",
						blockedUsers: [],
					},
					
					methods: {
						login: function(){
							let provider = new firebase.auth.TwitterAuthProvider();
							
							firebase.auth().signInWithPopup(provider).then(function(result){
								let db = firebase.database();
								let username = result.additionalUserInfo.username;
								
								let ref = db.ref("/allUsers/" + result.user.uid);
								ref.set({username});
							}).catch(function(error){
								console.error(error);
							});
						},
						
						logout: function(){
							firebase.auth().signOut();
							ref3.off();
							ref4.off();
							ref5.off();
						},
						
						approve: function(tweet){
							let self = this;
							let db = firebase.database();
							let ref = db.ref("/approvedTweets");
							
							ref.once("value").then(function(snapshot){
								let approvedTweets = snapshot.val();
								if (!approvedTweets) approvedTweets = [];
								else approvedTweets = Object.keys(approvedTweets).map(function(key){
									return approvedTweets[key];
								});
								
								if (approvedTweets.indexOf(tweet.url) < 0){
									approvedTweets.push(tweet.url);
									ref.set(approvedTweets);
								}
								
								self.tweetsToApprove.splice(self.tweetsToApprove.indexOf(tweet), 1);
								db.ref("/tweetsToApprove").set(self.tweetsToApprove);
							});
						},
						
						deny: function(tweet){
							let self = this;
							let db = firebase.database();
							
							self.tweetsToApprove.splice(self.tweetsToApprove.indexOf(tweet), 1);
							db.ref("/tweetsToApprove").set(self.tweetsToApprove);
							
							let shouldBlockUser = confirm("Would you like to block " + tweet.submitter + ", the user who submitted this tweet?");
							
							if (shouldBlockUser){
								self.blockUser(tweet.submitter);
							}
						},
						
						addAdminUser: function(username){
							let self = this;
							let db = firebase.database();
							db.ref("/adminUsers/" + username).set(true);
							self.userToAdmin = "";
						},
						
						removeAdminUser: function(username){
							let shouldRemoveAdminUser = confirm("Are you sure that you want to remove " + username + " as an administrator?");
							
							if (!shouldRemoveAdminUser) return;
							
							let db = firebase.database();
							db.ref("/adminUsers/" + username).set(null);
						},
						
						blockUser: function(username){
							let self = this;
							let db = firebase.database();
							db.ref("/blockedUsers/" + username).set(true);
							self.userToBlock = "";
						},
						
						unblockUser: function(username){
							let shouldUnblockUser = confirm("Are you sure that you want to unblock " + username + "?");
							
							if (!shouldUnblockUser) return;
							
							let db = firebase.database();
							db.ref("/blockedUsers/" + username).set(null);
						},
					},
					
					mounted: function(){
						let self = this;
						
						firebase.auth().onAuthStateChanged(function(user){
							document.getElementById("app").style.display = "block";
							self.isLoggedIn = !!user;
							
							if (ref3) ref3.off();
							if (ref4) ref4.off();
							if (ref5) ref5.off();
							if (ref6) ref6.off();
							
							if (user){
								let db = firebase.database();
								
								ref6 = db.ref("/allUsers/" + user.uid);
								
								ref6.on("value", function(snapshot){
									let user = snapshot.val();
									if (!user) return;
									
									if (ref3) ref3.off();
									
									ref3 = db.ref("/adminUsers");
									
									ref3.on("value", function(snapshot2){
										let adminUsers = snapshot2.val();
										
										if (!adminUsers || !adminUsers[user.username]){
											window.location.href = "{{ site.baseurl }}/";
										}
										
										self.adminUsers = Object.keys(adminUsers);
										self.isAdmin = true;
									});
								});
								
								ref4 = db.ref("/tweetsToApprove");
								
								ref4.on("value", function(snapshot){
									let tweetsToApprove = snapshot.val();
									if (!tweetsToApprove) return;
									self.tweetsToApprove = tweetsToApprove;
								});
								
								ref5 = db.ref("/blockedUsers");
								
								ref5.on("value", function(snapshot){
									let blockedUsers = snapshot.val();
									
									if (!blockedUsers){
										self.blockedUsers = [];
										return;
									}
									
									self.blockedUsers = Object.keys(blockedUsers);
								});
							}
						});
					},
				});
			};
		</script>
			
		</div>
	</body>
</html>
